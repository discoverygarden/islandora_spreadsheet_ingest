id: isi_node
label: Create nodes from rows in the csv.
migration_group: isi
source:
  columns:
    - 'ID'
    - 'title'
    - 'model'
    - 'member_of'
    - 'member_of_existing_entity'
    - 'description'
process:
  field_model:
    - plugin: get
      source: 'model'
    - plugin: skip_on_empty
      method: row
      message: '"model" column is missing'
    - plugin: static_map
      bypass: false
      map:
        'Image': 'http://purl.org/coar/resource_type/c_c513'
        'Digital Document': 'https://schema.org/DigitalDocument'
        'Video': 'http://purl.org/coar/resource_type/c_12ce'
        'Collection': 'http://purl.org/dc/dcmitype/Collection'
        'Audio': 'http://purl.org/coar/resource_type/c_18cc'
        'Binary': 'http://purl.org/coar/resource_type/c_1843'
    - plugin: entity_lookup
      bundle_key: vid
      bundle: islandora_models
      value_key: field_external_uri
      entity_type: taxonomy_term
      # XXX: migrate_plus's case comparison makes assumptions about the entity's
      # "main" property... we want "uri", but it assumes "value".
      ignore_case: true

  # Metadata.
  title: title
  field_display_hints:
    - plugin: static_map
      source: 'model'
      bypass: true
      map:
        'Image': 'http://openseadragon.github.io'
        'Digital Document': 'http://mozilla.github.io/pdf.js'
    - plugin: skip_on_empty
      method: process
    - plugin: entity_lookup
      bundle_key: vid
      bundle: islandora_display
      value_key: field_external_uri
      entity_type: taxonomy_term
      # XXX: migrate_plus's case comparison makes assumptions about the entity's
      # "main" property... we want "uri", but it assumes "value".
      ignore_case: true

  # The following facilitates assigning objects as either members of other
  # objects from this migration, or as members of previously ingested objects.
  # The example ingest for this module cannot take full advantage of this
  # functionality, but this provides a good reference for future templates.
  # TODO: Allow for parsing multiple values from 'Member_of' and
  # 'Member_of_existing_entity'.
  _member_of_csv_id:
    - plugin: skip_on_empty
      method: process
      source: 'member_of'
    - plugin: migration_lookup
      migration: isi_node

  _member_of_existing_entity:
    - plugin: skip_on_empty
      method: process
      source: 'member_of_existing_entity'
    - plugin: entity_lookup
      bundle_key: type
      bundle: islandora_object
      value_key: title
      entity_type: node

  field_member_of:
    - plugin: get
      source:
        - '@_member_of_csv_id'
        - '@_member_of_existing_entity'
    - plugin: skip_on_empty
      method: process
    - plugin: get

  field_faceted_subject:
    - plugin: get
      source: faceted_subject
    - plugin: skip_on_empty
      method: process
    - plugin: dgi_migrate.process.log
    - plugin: subdelimited_explode
      delimiter: ';'
      subdelimiter: '|'
      keys:
        - ffs_source
        - ffs_url
        - ffs_topic
        - ffs_genre
        - ffs_temp
        - ffs_geo
    - plugin: dgi_migrate.process.log
    - plugin: sub_process
      process:
        _sources/source:
          - plugin: get
            source: ffs_source
        _sources/uri:
          - plugin: get
            source: ffs_url
        _topic:
          - plugin: entity_lookup
            source: ffs_topic
            entity_type: taxonomy_term
            bundle: subject
            bundle_key: vid
            value_key: name
            # XXX: migrate_plus's case comparison makes assumptions about the entity's
            # "main" property... we want "uri", but it assumes "value".
            ignore_case: true
        _genre:
          - plugin: entity_lookup
            source: ffs_genre
            entity_type: taxonomy_term
            bundle: genre
            bundle_key: vid
            value_key: name
            # XXX: migrate_plus's case comparison makes assumptions about the entity's
            # "main" property... we want "uri", but it assumes "value".
            ignore_case: true
        _temporal:
          - plugin: entity_lookup
            source: ffs_temp
            entity_type: taxonomy_term
            bundle: temporal
            bundle_key: vid
            value_key: name
            # XXX: migrate_plus's case comparison makes assumptions about the entity's
            # "main" property... we want "uri", but it assumes "value".
            ignore_case: true
        _geographic:
          - plugin: entity_lookup
            source: ffs_geo
            entity_type: taxonomy_term
            bundle: geo_location
            bundle_key: vid
            value_key: name
            # XXX: migrate_plus's case comparison makes assumptions about the entity's
            # "main" property... we want "uri", but it assumes "value".
            ignore_case: true
        _paragraph:
          - plugin: isi_paragraph_generate
            type: faceted_subject
            values:
              field_authority_sources: '@_sources'
              field_topic_general_subdivision_: '@_topic'
              field_genre_form_subdivision_: '@_genre'
              field_temporal_chronological_sub: '@_temporal'
              field_geographic_geographic_subd: '@_geographic'
    - plugin: single_value
    - plugin: dgi_migrate.process.log
    - plugin: sub_process
      process:
        target_id:
          - plugin: extract
            source: _paragraph
            index: [target_id]
          - plugin: dgi_migrate.process.log
        target_revision_id:
          - plugin: extract
            source: _paragraph
            index: [target_revision_id]
    - plugin: dgi_migrate.process.log

destination:
  plugin: entity:node
  default_bundle: islandora_object
# Translation will make it so nodes won't delete on rollback.
#  translations: true
# Validation hides errors for debugging.
#  validate: true
dependencies:
  enforced:
    module:
      - islandora_spreadsheet_ingest
